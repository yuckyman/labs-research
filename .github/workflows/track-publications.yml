name: Track Publications

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  track-publications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq libxml2-utils
      
      - name: Install Python dependencies
        run: |
          pip install -r .github/scripts/requirements.txt
      
      - name: Parse faculty files
        id: parse-faculty
        run: |
          python3 .github/scripts/parse-faculty.py > faculty_list.json
          FACULTY_COUNT=$(jq -r '.total' faculty_list.json)
          echo "FACULTY_COUNT=$FACULTY_COUNT" >> $GITHUB_OUTPUT
          echo "Found $FACULTY_COUNT faculty members to track"
      
      - name: Process publications
        id: process-pubs
        env:
          UNPAYWALL_EMAIL: ${{ secrets.UNPAYWALL_EMAIL || 'github-actions@example.com' }}
        run: |
          python3 .github/scripts/process-publications.py faculty_list.json "$UNPAYWALL_EMAIL" > process_result.json
          NEW_COUNT=$(jq -r '.new_publications' process_result.json)
          PROCESSED=$(jq -r '.processed' process_result.json)
          echo "NEW_PUBS_FOUND=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "PROCESSED=$PROCESSED" >> $GITHUB_OUTPUT
          echo "Processed $PROCESSED publications, $NEW_COUNT new"
      
      - name: Commit and push changes
        if: steps.process-pubs.outputs.NEW_PUBS_FOUND != '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all new publication files and PDFs
          git add */publications/*.md */publications/*.pdf || true
          
          NEW_COUNT="${{ steps.process-pubs.outputs.NEW_PUBS_FOUND }}"
          
          if [ "$NEW_COUNT" -eq 1 ]; then
            COMMIT_MSG="üìö Add $NEW_COUNT new publication"
          else
            COMMIT_MSG="üìö Add $NEW_COUNT new publications"
          fi
          
          COMMIT_MSG="$COMMIT_MSG

          Automated publication tracking update
          - Parsed faculty.md files from all labs
          - Queried Crossref, arXiv, and bioRxiv APIs
          - Downloaded PDFs from open access sources
          - Converted PDFs to markdown
          - Created individual publication files with YAML frontmatter
          - Checked for duplicates
          
          Run date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push || echo "Nothing to push"
          
          echo "‚úì Successfully processed $NEW_COUNT new publication(s)"
      
      - name: No new publications found
        if: steps.process-pubs.outputs.NEW_PUBS_FOUND == '0'
        run: |
          echo "‚ÑπÔ∏è  No new publications found"
          echo "All tracked faculty members are up to date!"
